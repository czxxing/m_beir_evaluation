# NDCG@k 计算示例

CG、DCG、NDCG 计算公式详解

1. CG（Cumulative Gain）累计增益

基本公式

CG@k = Σ relᵢ （i 从 1 到 k）

其中：
• relᵢ = 第 i 个结果的相关性分数

• k = 考虑的前 k 个结果

计算示例

对于相关性分数 [3, 2, 0, 1]：
• CG@2 = 3 + 2 = 5

• CG@4 = 3 + 2 + 0 + 1 = 6

特点：只考虑相关性，不考虑排名位置。

2. DCG（Discounted Cumulative Gain）折损累计增益

公式版本1（标准公式）

DCG@k = Σ (relᵢ / log₂(i + 1)) （i 从 1 到 k）

公式版本2（强调高相关性）

DCG@k = Σ ((2^relᵢ - 1) / log₂(i + 1)) （i 从 1 到 k）

折损因子说明

排名 i log₂(i+1) 折损权重 (1/log₂(i+1))

1 log₂(2) = 1.000 1.000

2 log₂(3) ≈ 1.585 0.631

3 log₂(4) = 2.000 0.500

4 log₂(5) ≈ 2.322 0.431

5 log₂(6) ≈ 2.585 0.387

计算示例（使用版本1）

对于相关性分数 [3, 2, 3, 0]，计算 DCG@4：
• 第1位：3 / log₂(2) = 3 / 1 = 3.000

• 第2位：2 / log₂(3) ≈ 2 / 1.585 = 1.262

• 第3位：3 / log₂(4) = 3 / 2 = 1.500

• 第4位：0 / log₂(5) ≈ 0 / 2.322 = 0.000

DCG@4 = 3.000 + 1.262 + 1.500 + 0.000 = 5.762

3. NDCG（Normalized DCG）归一化折损累计增益

核心公式

NDCG@k = DCG@k / IDCG@k

其中：
• IDCG@k = 理想排序下的 DCG@k

• IDCG@k 计算：将相关性分数按降序排列后计算的 DCG@k

完整计算步骤

1. 计算实际 DCG@k
2. 计算理想 DCG@k（IDCG@k）
3. NDCG@k = DCG@k / IDCG@k

计算示例

实际排序相关性：[3, 2, 3, 0, 1]

步骤1：计算 DCG@5
• 第1位：3 / log₂(2) = 3.000

• 第2位：2 / log₂(3) ≈ 1.262

• 第3位：3 / log₂(4) = 1.500

• 第4位：0 / log₂(5) ≈ 0.000

• 第5位：1 / log₂(6) ≈ 0.387

• DCG@5 = 3.000 + 1.262 + 1.500 + 0.000 + 0.387 = 6.149

步骤2：计算 IDCG@5
• 理想排序：按相关性降序排列 → [3, 3, 2, 1, 0]

• 第1位：3 / log₂(2) = 3.000

• 第2位：3 / log₂(3) ≈ 1.893

• 第3位：2 / log₂(4) = 1.000

• 第4位：1 / log₂(5) ≈ 0.431

• 第5位：0 / log₂(6) = 0.000

• IDCG@5 = 3.000 + 1.893 + 1.000 + 0.431 + 0.000 = 6.324

步骤3：计算 NDCG@5
• NDCG@5 = 6.149 / 6.324 ≈ 0.972

公式对比总结

指标 公式 特点 取值范围

CG@k Σ relᵢ 简单求和，不考虑位置 [0, +∞)

DCG@k Σ (relᵢ / log₂(i+1)) 考虑位置折损 [0, +∞)

NDCG@k DCG@k / IDCG@k 归一化到[0,1] [0, 1]


## 场景：电影推荐系统评估

假设我们有一个电影推荐系统，为用户推荐5部电影（k=5）。用户对这些电影的真实评分如下（0-3分制）：

**评分标准：**
- 3分：非常喜欢（用户会打5星）
- 2分：比较喜欢（用户会打4星）  
- 1分：一般喜欢（用户会打3星）
- 0分：不喜欢（用户会打1-2星）

---

## 步骤1：定义推荐结果和真实评分

**推荐系统给出的排序（当前排序）：**
| 排名 | 电影名称 | 系统预测的评分 | 用户真实评分 |
|------|----------|---------------|------------|
| 1 | 电影A | 高 | 3（非常喜欢） |
| 2 | 电影B | 中 | 2（比较喜欢） |
| 3 | 电影C | 高 | 1（一般喜欢） |
| 4 | 电影D | 低 | 0（不喜欢） |
| 5 | 电影E | 中 | 2（比较喜欢） |

**当前排序的相关性分数序列：** `[3, 2, 1, 0, 2]`

---

## 步骤2：计算 DCG@5（折损累计增益）

**计算公式：** DCG@k = Σ(相关性分数 / log₂(排名位置))

**计算过程：**
- 第1名：3 / log₂(1+1) = 3 / log₂(2) = 3 / 1 = **3.000**
- 第2名：2 / log₂(2+1) = 2 / log₂(3) ≈ 2 / 1.585 = **1.262**
- 第3名：1 / log₂(3+1) = 1 / log₂(4) = 1 / 2 = **0.500**
- 第4名：0 / log₂(4+1) = 0 / log₂(5) ≈ 0 / 2.322 = **0.000**
- 第5名：2 / log₂(5+1) = 2 / log₂(6) ≈ 2 / 2.585 = **0.774**

**DCG@5 = 3.000 + 1.262 + 0.500 + 0.000 + 0.774 = 5.536**

---

## 步骤3：计算 IDCG@5（理想DCG）

**理想排序**（按真实评分从高到低排列）：
| 排名 | 电影 | 真实评分 |
|------|------|----------|
| 1 | 电影A | 3 |
| 2 | 电影E | 2 |
| 3 | 电影B | 2 |
| 4 | 电影C | 1 |
| 5 | 电影D | 0 |

**理想排序的相关性分数序列：** `[3, 2, 2, 1, 0]`

**计算IDCG@5：**
- 第1名：3 / log₂(2) = 3 / 1 = **3.000**
- 第2名：2 / log₂(3) ≈ 2 / 1.585 = **1.262**
- 第3名：2 / log₂(4) = 2 / 2 = **1.000**
- 第4名：1 / log₂(5) ≈ 1 / 2.322 = **0.431**
- 第5名：0 / log₂(6) ≈ 0 / 2.585 = **0.000**

**IDCG@5 = 3.000 + 1.262 + 1.000 + 0.431 + 0.000 = 5.693**

---

## 步骤4：计算 NDCG@5

**NDCG@5 = DCG@5 / IDCG@5 = 5.536 / 5.693 ≈ 0.972**

---

## 结果分析

**NDCG@5 = 0.972** 这个结果非常接近1.0，说明：

1. **推荐质量很高**：当前排序与理想排序非常接近
2. **高相关性的电影排在了前面**：电影A（评分3）排在第1位是正确的
3. **稍有改进空间**：电影E（评分2）应该比电影C（评分1）排名更靠前

## 对比不同k值的影响

如果我们计算 **NDCG@3**（只看前3个推荐）：

**DCG@3 =** 3.000 + 1.262 + 0.500 = 4.762  
**IDCG@3 =** 3.000 + 1.262 + 1.000 = 5.262  
**NDCG@3 =** 4.762 / 5.262 ≈ 0.905

可以看到 **NDCG@3 (0.905) < NDCG@5 (0.972)**，这说明：
- 前3个推荐的排序质量不如前5个推荐
- 系统在前3名中犯了一个错误：把评分1的电影C排在了评分2的电影B和电影E之前

## 实际意义

这个NDCG@5得分0.972意味着：
- 如果完美排序的质量是100分，当前系统得了97.2分
- 在商业应用中，这个分数通常被认为是优秀的
- 如果低于0.8可能就需要优化排序算法了

通过这个例子，你可以看到NDCG@k如何综合考虑相关性和排名位置，为推荐系统的排序质量提供一个0-1之间的标准化评估分数。